<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SecureString.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">BJAD Common Library</a> &gt; <a href="index.source.html" class="el_package">bjad.common.string</a> &gt; <span class="el_source">SecureString.java</span></div><h1>SecureString.java</h1><pre class="source lang-java linenums">package bjad.common.string;

import java.security.spec.KeySpec;
import java.util.Base64;
import java.util.UUID;

import javax.crypto.Cipher;
import javax.crypto.SecretKey;
import javax.crypto.SecretKeyFactory;
import javax.crypto.spec.IvParameterSpec;
import javax.crypto.spec.PBEKeySpec;
import javax.crypto.spec.SecretKeySpec;

/**
 * Wrapper for keeping strings secured by encrypting them in memory, or 
 * to decrypt/encrypt strings from setting files or other external sources.
 *
 * @author 
 *   Ben Dougall
 */
public class SecureString
{
<span class="fc" id="L23">   private IvParameterSpec ivspec = new IvParameterSpec(</span>
         new byte[] {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0});
   
   private byte[] encryptedValue;
   
<span class="fc" id="L28">   private SecretKeySpec secretKey = null;</span>
   
<span class="fc" id="L30">   private char[] secretKeyFactoryAlgorithm = null;</span>
   
<span class="fc" id="L32">   private char[] encryptionAlgorithm = null;</span>
   
<span class="fc" id="L34">   private char[] cipherAlgorithm = null;</span>
   
   /**
    * Creates an empty secure string with a randomized
    * key and salt value. 
    */
   public SecureString()
   {
<span class="fc" id="L42">      this(&quot;&quot;, &quot;&quot;, &quot;&quot;);</span>
<span class="fc" id="L43">   }</span>
   
   /**
    * Creates a securestring for the value passed using 
    * a randomized key and salt value. Useful for securely
    * storing a password or sensitive information during 
    * the runtime for the application. 
    * 
    * @param value
    *    The string to encrypt.
    */
   public SecureString(String value)
   {
<span class="fc" id="L56">      this(&quot;&quot;, &quot;&quot;, value);</span>
<span class="fc" id="L57">   }</span>
   
   /**
    * Creates an empty Secure String but sets the encryption
    * key and the salting value for future operations. 
    * 
    * @param key
    *    The encryption key to use. If empty, the key will be
    *    randomized.
    * @param salt
    *    The salting value to use. If empty, the salt value will be
    *    randomized.      
    */
   public SecureString(String key, String salt)
   {
<span class="fc" id="L72">      this(key, salt, &quot;&quot;);</span>
<span class="fc" id="L73">   }</span>
   
   /**
    * Creates the secure string with the key, salt, and initial
    * value set within it. 
    * 
    * @param key
    *    The encryption key to use. If empty, the key will be
    *    randomized.
    * @param salt
    *    The salting value to use. If empty, the salt value will be
    *    randomized.
    * @param value
    *    The string to store securely within the object.
    */
   public SecureString(String key, String salt, String value)
<span class="fc" id="L89">   {</span>
<span class="fc" id="L90">      initializeCryptoObjects(key, salt);</span>
<span class="fc" id="L91">      setString(value);</span>
<span class="fc" id="L92">   }</span>
   
   /**
    * Provides the string stored securely within the object. 
    *  
    * @return
    *    The actual string stored in the object. 
    * @throws SecureStringException
    *    Any encryption exceptions will be thrown. If the value 
    *    if coming from an external source, the calling function 
    *    should be catching for this exception in case the value
    *    set was invalid. 
    */
   public String getString() throws SecureStringException
   {
<span class="fc bfc" id="L107" title="All 2 branches covered.">      if (encryptedValue == null)</span>
      {
<span class="fc" id="L109">         return &quot;&quot;;</span>
      }
      
      try
      {
<span class="fc" id="L114">         Cipher cipher = Cipher.getInstance(getStringFromCharArray(cipherAlgorithm, &quot;AES/CBC/PKCS5PADDING&quot;));</span>
<span class="fc" id="L115">         cipher.init(Cipher.DECRYPT_MODE, secretKey, ivspec);</span>
<span class="fc" id="L116">         return new String(cipher.doFinal(encryptedValue));</span>
      }      
<span class="nc" id="L118">      catch (Exception ex)</span>
      {
<span class="nc" id="L120">         throw new SecureStringException(ex);</span>
      }
   }
   
   /**
    * Sets the string value that is to be stored securely 
    * in the object. 
    * @param value
    *    The value to store securely. 
    * @throws SecureStringException
    *    Any encryption exceptions will be thrown.
    */
   public void setString(String value) throws SecureStringException
   {
<span class="fc bfc" id="L134" title="All 4 branches covered.">      if (value == null || value.trim().isEmpty())</span>
      {
<span class="fc" id="L136">         encryptedValue = null;</span>
<span class="fc" id="L137">         return;</span>
      }
      
      try
      {
<span class="fc" id="L142">         Cipher cipher = Cipher.getInstance(getStringFromCharArray(cipherAlgorithm, &quot;AES/CBC/PKCS5PADDING&quot;));</span>
<span class="fc" id="L143">         cipher.init(Cipher.ENCRYPT_MODE, secretKey, ivspec);</span>
<span class="fc" id="L144">         encryptedValue = cipher.doFinal(value.getBytes(&quot;UTF-8&quot;));</span>
      }      
<span class="nc" id="L146">      catch (Exception ex)</span>
      {
<span class="nc" id="L148">         throw new SecureStringException(ex);</span>
<span class="fc" id="L149">      }</span>
<span class="fc" id="L150">   }</span>
   
   /**
    * Returns the base64 string for the encrypted string 
    * in the object. 
    * 
    * @return 
    *    The base 64 string of the encrypted value, or empty
    *    string if nothing is stored. 
    */
   public String getBase64String()
   {
<span class="pc bpc" id="L162" title="1 of 4 branches missed.">      if (encryptedValue == null || encryptedValue.length == 0)</span>
      {
<span class="fc" id="L164">         return &quot;&quot;;</span>
      }
<span class="fc" id="L166">      return Base64.getEncoder().encodeToString(encryptedValue);</span>
   }
   
   /**
    * Sets the encrypted value within the object from the 
    * base 64 value passed to the function. 
    * 
    * @param base64String  
    *    The base 64 to decode and store in the object
    * @return
    *    True if the base 64 string could be decoded and 
    *    stored, false otherwise.
    */
   public boolean setFromBase64String(String base64String)
   {
<span class="fc bfc" id="L181" title="All 4 branches covered.">      if (base64String == null || base64String.trim().isEmpty())</span>
      {
<span class="fc" id="L183">         encryptedValue = null;</span>
      }
      else
      {
         try
         {
<span class="fc" id="L189">            encryptedValue = Base64.getDecoder().decode(base64String);</span>
         }
<span class="nc" id="L191">         catch (Exception ex)</span>
         {
<span class="nc" id="L193">            encryptedValue = null;</span>
<span class="fc" id="L194">         }</span>
      }
<span class="pc bpc" id="L196" title="1 of 4 branches missed.">      return encryptedValue != null &amp;&amp; encryptedValue.length &gt; 0;</span>
   }

   private String getStringFromCharArray(char[] val, String defaultValue)
   {
<span class="fc" id="L201">      String result = defaultValue;</span>
<span class="pc bpc" id="L202" title="3 of 4 branches missed.">      if (val != null &amp;&amp; val.length &gt; 0)</span>
      {
<span class="nc" id="L204">         result = new String(val);</span>
      }
<span class="fc" id="L206">      return result;</span>
   }
   
   private void initializeCryptoObjects(String key, String salt)
   {
      try
      {
         char[] keyArray;
         
<span class="fc bfc" id="L215" title="All 4 branches covered.">         if (key == null || key.trim().isEmpty())</span>
         {
<span class="fc" id="L217">            keyArray = UUID.randomUUID().toString().toCharArray();</span>
         }
         else
         {
<span class="fc" id="L221">            keyArray = key.toCharArray();</span>
         }
         
<span class="fc bfc" id="L224" title="All 2 branches covered.">         String saltValue = </span>
<span class="fc bfc" id="L225" title="All 2 branches covered.">               (salt == null || salt.trim().isEmpty()) ? </span>
<span class="fc" id="L226">                     String.valueOf(System.nanoTime()) : </span>
                     salt;
         
<span class="fc" id="L229">         String method = getStringFromCharArray(secretKeyFactoryAlgorithm, &quot;PBKDF2WithHmacSHA256&quot;);</span>
      
<span class="fc" id="L231">         SecretKeyFactory factory = SecretKeyFactory.getInstance(method);</span>
<span class="fc" id="L232">         KeySpec spec = new PBEKeySpec(keyArray, saltValue.getBytes(), 65536, 256);</span>
<span class="fc" id="L233">         SecretKey temp = factory.generateSecret(spec);</span>
         
<span class="fc" id="L235">         method = getStringFromCharArray(encryptionAlgorithm, &quot;AES&quot;);</span>
<span class="fc" id="L236">         secretKey = new SecretKeySpec(temp.getEncoded(), method);</span>
         
         try
         {
<span class="pc bpc" id="L240" title="1 of 2 branches missed.">            if (!temp.isDestroyed())</span>
            {
<span class="nc" id="L242">               temp.destroy();</span>
            }
         }
<span class="fc" id="L245">         catch (Exception ignore) </span>
         {
            // Do nothing, purely cleanup.
<span class="nc" id="L248">         }</span>
      } 
<span class="nc" id="L250">      catch (Exception ex)</span>
      {
<span class="nc" id="L252">         throw new SecureStringException(ex);</span>
<span class="fc" id="L253">      }</span>
<span class="fc" id="L254">   }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>